<html>
<head>
<script src="/js-client/player.js" ></script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  /*global ga*/
  ga('create', 'UA-105814598-1', 'auto');
  ga('send', 'pageview');
</script>

<script>

/* global DigitalFrontierAS */
var player = new DigitalFrontierAS.Player();

var compositions = ["WIPmp3.json"];

var songUrl = "";

var ready = false;

player.onEnded = function () {
	var image = document.getElementById("image");
	image.src = "play-button.svg";
	image.style.display = "block";
	playing = false;
	var video = document.getElementById("video");
	video.pause();
};

player.onPlaying = function () {
	var image = document.getElementById("image");
	var video = document.getElementById("video");

	var isPlaying = video.currentTime > 0 && !video.paused && !video.ended && video.readyState > 2;

	if (!isPlaying) {
		video.play();
		image.style.display = "none";
		ga('send', 'event', 'DAM', 'wait-resume', songUrl); /*global ga*/
	}
};

player.onWaiting = function () {
	var image = document.getElementById("image");
	var video = document.getElementById("video");
	video.pause();
	image.src = "/TCH02/loading.gif";
	image.style.display = "block";
	ga('send', 'event', 'DAM', 'wait', songUrl);
};

var playing = false;

function randomElement(array) {
    if (!array) return null;
    if (array.length === 0) return null;
    var index = Math.floor(Math.random() * array.length);
    return array[index];
}


function imageClicked() {
	if (ready) {
		var image = document.getElementById("image");
		var video = document.getElementById("video");
		if (playing) {
			player.stop();
			image.src = "play-button.svg";
			image.style.display = "block";
			playing = false;
			video.pause();
			ga('send', 'event', 'DAM', 'stop', songUrl);
		} else {
      var image = document.getElementById("image");
      image.src = "/TCH02/loading.gif";
      image.style.display = "block";
      player.play();
      playing = true;
      video.currentTime = 0.0;
			ga('send', 'event', 'DAM', 'play', songUrl);
		}
	}
}

window.onload = function () {
  console.debug("window.onload");
	var video = document.getElementById("video");
  video.oncanplaythrough = function () {
    if (video.autoplay === false) return;
    console.debug("video.oncanplaythrough");
    video.pause();
    video.autoplay = false;
    video.controls = false;
  	video.currentTime = 0.0;

    songUrl = randomElement(compositions);
    try {
      var request = new XMLHttpRequest();
      request.open('GET', songUrl, true);
      request.onload = function () {
        console.debug("request.onload");
        var song = JSON.parse(request.responseText);
        player.load(song, "/A/");
        //player.load(song);

      	var image = document.getElementById("image");
      	image.src = "play-button.svg";
      	ready = true;
      };
      request.send();
    }
    catch (e) {}
  };
}

</script>

<style>
	.fullscreen {
		position: fixed;
		width: 100%;
		height: 100%;
		left: 0;
		top: 0;
	}
	#video {
		z-index: 10;
		background-color: #101010;
	}
	#image {
		display: block;
		margin-left: auto;
		margin-right: auto;
		width: 20vw;
		height: 20vw;
		text-align: center;
		position: absolute;
		top: calc(50% - 3vw);
		left: calc(50% - 10vw);
    	/*
		vertical-align: middle;
		display: table-cell;
		text-align: center;
		*/
	}
	#imagediv {
		background: rgba(255,255,255,0.0);
		/* border: 10px solid black; */
		z-index: 20;
	}
</style>

</head>


<body valign="top">
	<div id="imagediv" class="fullscreen" onclick="imageClicked()"><img src="/TCH02/loading.gif" id="image"/></div>
	<video id="video" class="fullscreen" loop muted autoplay>
		<source src="TCH01.mp4" />
	</video>
</body>
</html>
